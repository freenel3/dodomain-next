#!/bin/bash

# Dodomain Next.js Deployment Script
# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ

set -e  # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ

echo "ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Dodomain Ð½Ð° Next.js..."

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# 1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js
echo -e "${BLUE}ðŸ“¦ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Node.js...${NC}"
if ! command -v node &> /dev/null; then
    echo "Node.js Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼..."
    curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
    sudo apt-get install -y nodejs
fi

NODE_VERSION=$(node -v)
echo -e "${GREEN}âœ… Node.js ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½: $NODE_VERSION${NC}"

# 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° PostgreSQL
echo -e "${BLUE}ðŸ—„ï¸  ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° PostgreSQL...${NC}"
if ! command -v psql &> /dev/null; then
    echo "PostgreSQL Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼..."
    sudo apt-get update
    sudo apt-get install -y postgresql postgresql-contrib
    sudo systemctl start postgresql
    sudo systemctl enable postgresql
fi

echo -e "${GREEN}âœ… PostgreSQL ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½${NC}"

# 3. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
echo -e "${BLUE}ðŸ’¾ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…...${NC}"
sudo -u postgres psql -c "CREATE DATABASE dodomain;" 2>/dev/null || echo "Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
sudo -u postgres psql -c "CREATE USER dodomain_user WITH PASSWORD 'dodomain_password_2024';" 2>/dev/null || echo "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE dodomain TO dodomain_user;"
echo -e "${GREEN}âœ… Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð°${NC}"

# 4. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
echo -e "${BLUE}ðŸ“š Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹...${NC}"
npm install

# 5. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° .env Ñ„Ð°Ð¹Ð»Ð°
echo -e "${BLUE}âš™ï¸  Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°...${NC}"
cat > .env.local << EOF
# Database
DATABASE_URL="postgresql://dodomain_user:dodomain_password_2024@localhost:5432/dodomain"

# App
NODE_ENV=production
NEXT_PUBLIC_SITE_URL=https://dodomain.ru
EOF

echo -e "${GREEN}âœ… .env Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½${NC}"

# 6. Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Prisma Ð¸ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ñ Ð‘Ð”
echo -e "${BLUE}ðŸ”„ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…...${NC}"
npx prisma generate
npx prisma db push
npx prisma db seed 2>/dev/null || echo "Seed ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼"

echo -e "${GREEN}âœ… Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°${NC}"

# 7. Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
echo -e "${BLUE}ðŸ—ï¸  Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°...${NC}"
npm run build

echo -e "${GREEN}âœ… ÐŸÑ€Ð¾ÐµÐºÑ‚ ÑÐ¾Ð±Ñ€Ð°Ð½${NC}"

# 8. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° PM2 Ð´Ð»Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð¼
echo -e "${BLUE}ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° PM2...${NC}"
npm install -g pm2

# 9. Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
echo -e "${BLUE}ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ...${NC}"
pm2 stop dodomain 2>/dev/null || true
pm2 delete dodomain 2>/dev/null || true
pm2 start npm --name "dodomain" -- start
pm2 save
pm2 startup

echo -e "${GREEN}âœ… ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾!${NC}"

# 10. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Nginx
echo -e "${BLUE}ðŸŒ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Nginx...${NC}"
if ! command -v nginx &> /dev/null; then
    sudo apt-get install -y nginx
fi

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx
sudo tee /etc/nginx/sites-available/dodomain.ru > /dev/null << 'NGINX_EOF'
server {
    listen 80;
    server_name dodomain.ru www.dodomain.ru;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
NGINX_EOF

# ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
sudo ln -sf /etc/nginx/sites-available/dodomain.ru /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default
sudo nginx -t
sudo systemctl restart nginx
sudo systemctl enable nginx

echo -e "${GREEN}âœ… Nginx Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½${NC}"

# 11. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð° (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
echo -e "${BLUE}ðŸ”’ Ð¥Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚? (y/n)${NC}"
read -r install_ssl
if [ "$install_ssl" = "y" ]; then
    sudo apt-get install -y certbot python3-certbot-nginx
    sudo certbot --nginx -d dodomain.ru -d www.dodomain.ru --non-interactive --agree-tos --email admin@dodomain.ru
    echo -e "${GREEN}âœ… SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½${NC}"
fi

echo ""
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}ðŸŽ‰ Ð”Ð•ÐŸÐ›ÐžÐ™ Ð—ÐÐ’Ð•Ð Ð¨ÐÐ Ð£Ð¡ÐŸÐ•Ð¨ÐÐž!${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "${BLUE}ðŸ“Š Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ:${NC}"
echo -e "  ðŸŒ URL: http://dodomain.ru"
echo -e "  ðŸ“ Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: $(pwd)"
echo -e "  ðŸ—„ï¸  Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…: dodomain"
echo -e "  ðŸ”§ PM2 Ð¿Ñ€Ð¾Ñ†ÐµÑÑ: dodomain"
echo ""
echo -e "${BLUE}ðŸ“ ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:${NC}"
echo -e "  pm2 status          - Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ"
echo -e "  pm2 logs dodomain   - Ð›Ð¾Ð³Ð¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ"
echo -e "  pm2 restart dodomain - ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº"
echo -e "  pm2 stop dodomain   - ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°"
echo ""
echo -e "${GREEN}âœ¨ ÐŸÑ€Ð¾ÐµÐºÑ‚ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ!${NC}"
